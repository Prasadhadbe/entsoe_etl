name: Deploy to Azure AKS

on:
  push:
    branches:
      - main

env:
  ACR_NAME: airflowacrcluster
  AKS_RESOURCE_GROUP: airflow-rg
  AKS_CLUSTER_NAME: airflow-aks
  IMAGE_NAME: airflow
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        run: |
          az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --overwrite-existing

      - name: Log in to ACR
        run: |
          az acr login --name $ACR_NAME

      - name: Build and Push Docker Image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG -f Dockerfile .
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

      - name: Replace image tag in deployments
        run: |
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-webserver-deployment.yaml
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-scheduler-deployment.yaml
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-init-job.yaml

      - name: Apply Namespace first
        run: |
          kubectl apply -f k8s/airflow-namespace.yaml
          echo "Waiting 5 seconds for namespace to be registered..."
          sleep 5

      - name: Verify Namespace Creation
        run: |
          kubectl get namespace airflow || {
            echo "Namespace 'airflow' is missing. Applying namespace manifest.";
            kubectl apply -f k8s/airflow-namespace.yaml;
          }

      - name: Apply rest of manifests
        run: |
          kubectl apply -f k8s/

      - name: Wait for airflow-init job to complete
        run: |
          echo "‚è≥ Waiting for airflow-init job to complete..."
          if ! kubectl wait --for=condition=complete job/airflow-init -n airflow --timeout=180s; then
            echo "‚ùå airflow-init job failed or took too long."
            kubectl get pods -n airflow
            kubectl describe pod -l job-name=airflow-init -n airflow
            kubectl logs -n airflow -l job-name=airflow-init --tail=50
            exit 1
          fi
          echo "‚úÖ airflow-init job completed successfully."

      - name: Wait for Airflow Webserver Pod
        run: |
          echo "Waiting for webserver pod to be ready..."
          kubectl wait pod -n airflow \
            --for=condition=Ready \
            -l app=airflow-webserver \
            --timeout=2000s || {
              echo "Webserver pod didn't become ready immediately. Waiting 10 seconds before checking again..."
              sleep 10
              
              # Try one more time after the delay
              kubectl wait pod -n airflow \
                --for=condition=Ready \
                -l app=airflow-webserver \
                --timeout=10s || {
                  echo "Webserver pod still not ready after waiting. Printing debug logs:"
                  kubectl get pods -n airflow -o wide
                  kubectl describe pods -n airflow -l app=airflow-webserver
                  kubectl logs -n airflow -l app=airflow-webserver --tail=50
                  exit 1
                }
            }
          echo "Webserver pod is ready!"

      - name: Debug Airflow Deployment
        run: |
          kubectl get all -n airflow;
          kubectl describe pods -n airflow;
          kubectl logs -n airflow -l app=airflow-webserver --all-containers=true;

      - name: Restart Airflow Deployments
        run: |
          kubectl rollout restart deployment airflow-webserver -n airflow
          kubectl rollout restart deployment airflow-scheduler -n airflow

      - name: Get Webserver Pod Name
        id: get-pod
        run: |
          POD_NAME=$(kubectl get pods -n airflow -l app=airflow-webserver -o jsonpath="{.items[0].metadata.name}")
          echo "Using pod: $POD_NAME"
          echo "pod_name=$POD_NAME" >> $GITHUB_OUTPUT

      - name: Get Airflow Webserver Public IP
        run: |
          echo "üåê Fetching LoadBalancer IP for Airflow Webserver..."
          for i in {1..10}; do
            IP=$(kubectl get svc airflow-webserver -n airflow -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
            if [ -n "$IP" ]; then
              echo "‚úÖ Airflow Webserver is live at: http://$IP:8080"
              break
            else
              echo "Waiting for LoadBalancer IP to be assigned..."
              sleep 10
            fi
          done
