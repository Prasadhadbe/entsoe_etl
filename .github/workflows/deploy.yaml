name: Deploy to Azure AKS

on:
  push:
    branches:
      - main

env:
  ACR_NAME: airflowacr26970
  AKS_RESOURCE_GROUP: airflow-rg
  AKS_CLUSTER_NAME: airflow-aks
  IMAGE_NAME: airflow
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        run: |
          az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --overwrite-existing

      - name: Log in to ACR
        run: |
          az acr login --name $ACR_NAME

      - name: Build and Push Docker Image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG -f Dockerfile .
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

      - name: Replace image tag in deployments
        run: |
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-webserver-deployment.yaml
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-scheduler-deployment.yaml
          sed -i "s|$ACR_NAME.azurecr.io/airflow:.*|$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG|g" k8s/airflow-init-job.yaml

      - name: Apply Namespace first
        run: |
          kubectl apply -f k8s/airflow-namespace.yaml
          echo "Waiting 5 seconds for namespace to be registered..."
          sleep 5

      - name: Apply rest of manifests
        run: |
          kubectl apply -f k8s/
          echo "Waiting for webserver pod to be created..."

          # Wait until the webserver pod is listed (i.e., created)
          POD_CREATED=false
          for i in {1..10}; do
            if kubectl get pods -n airflow -l component=webserver | grep webserver; then
              echo "✅ Webserver pod found!"
              POD_CREATED=true
              break
            fi
            echo "⏳ Webserver pod not found yet. Retrying in 10s..."
            sleep 10
          done

          if [ "$POD_CREATED" = false ]; then
            echo "❌ Webserver pod was not created in time."
            kubectl get pods -n airflow
            exit 1
          fi

          # Now wait for the webserver pod to be Ready
          echo "🔄 Waiting for webserver pod to be ready..."
          if ! kubectl wait --for=condition=ready pod -l component=webserver -n airflow --timeout=180s; then
            echo "❌ Webserver pod did not become ready in time."
            echo "📋 Debugging info:"
            kubectl get pods -n airflow
            kubectl describe pods -l component=webserver -n airflow
            exit 1
          fi

          echo "✅ Webserver pod is ready!"

      - name: Get Webserver Pod Name
        id: get-pod
        run: |
          POD_NAME=$(kubectl get pods -n airflow -l app=airflow-webserver -o jsonpath="{.items[0].metadata.name}")
          echo "Using pod: $POD_NAME"
          echo "pod_name=$POD_NAME" >> $GITHUB_OUTPUT

      - name: Copy DAGs to Pod
        run: |
          kubectl cp ./dags ${{ steps.get-pod.outputs.pod_name }}:/opt/airflow/ -c webserver

      - name: Restart Airflow Scheduler
        run: |
          kubectl rollout restart deployment airflow-scheduler
